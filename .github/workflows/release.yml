name: Release Build

on:
  push:
    branches:
      - main

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      # 1) Build (sign only) + dmg output
      - name: Build Tauri app (sign, no release, no notarize)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        with:
          args: --bundles dmg

      # 2) locate dmg
      - name: Locate DMG
        run: |
          echo "Listing bundles:"
          find src-tauri/target/release/bundle -maxdepth 5 -type f \( -name "*.dmg" -o -name "*.zip" \) -print
          DMG_PATH="$(ls -1 src-tauri/target/release/bundle/dmg/*.dmg | head -n 1)"
          if [ -z "$DMG_PATH" ]; then
            echo "DMG not found"
            exit 1
          fi
          echo "DMG_PATH=$DMG_PATH" >> $GITHUB_ENV
          echo "DMG: $DMG_PATH"

      # 3) notarize dmg
      - name: Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool submit "$DMG_PATH" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

      # 4) staple dmg
      - name: Staple DMG
        run: |
          xcrun stapler staple "$DMG_PATH"
          xcrun stapler validate "$DMG_PATH"

      # 5) create release (if missing) + upload stapled dmg
      - name: Upload stapled DMG to GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"

          # Create release if it doesn't exist yet (idempotent)
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" \
              --title "Champollion Deck $TAG" \
              --notes "アプリケーション署名を施し、一般的な環境でインストールできるようになりました。"
          fi

          # Upload (overwrite if already present)
          gh release upload "$TAG" "$DMG_PATH" --clobber

